name: Generate MikroTik RSC Files (Address-List only)

on:
  schedule:
    - cron: "30 0 * * 1" # 00:30 UTC Monday
  workflow_dispatch:

permissions:
  contents: write

env:
  MAX_ENTRIES_PER_FILE: 350
  SITE_LIST: "youtube.com,googlevideo.com,ytimg.com,instagram.com,cdninstagram.com,chatgpt.com"
  CIDR4_URL_TEMPLATE: https://iplist.opencck.org/?format=text&data=cidr4&site={site}
  IP4_URL_TEMPLATE: https://iplist.opencck.org/?format=text&data=ip4&site={site}

jobs:
  generate-rsc:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # 1. CIDR4 → Address-List (iplistCIDRv4)
      - name: Process CIDR4 → Address-List (iplistCIDRv4)
        run: |
          set -e
          IFS=',' read -ra site_array <<< "${{ env.SITE_LIST }}"
          CIDR4_URL_TEMPLATE="${{ env.CIDR4_URL_TEMPLATE }}"
          MAX="${{ env.MAX_ENTRIES_PER_FILE }}"
          OUTPUT_DIR="for_scripts/iplistCIDRv4"
          mkdir -p "$OUTPUT_DIR"

          gen_addr() {
            local out="$1" comment="$2"
            shift 2
            {
              echo ":global AddressList"
              echo "/ip firewall address-list"
              for e in "$@"; do
                addr=${e#*:}
                echo ":do {add list=\$AddressList comment=$comment address=$addr} on-error {}"
              done
            } > "$out"
          }

          for site in "${site_array[@]}"; do
            site=$(echo "$site" | xargs)
            cidr_url="${CIDR4_URL_TEMPLATE//\{site\}/$site}"
            curl -s -f "$cidr_url" > "input_cidr4_$site.txt" || continue

            cidrs=$(grep -E '^([0-9]{1,3}\.){3}[0-9]{1,3}/[0-9]{1,2}$' "input_cidr4_$site.txt" | sort -u)
            [ -z "$cidrs" ] && continue

            all_entries=()
            while IFS= read -r cidr; do all_entries+=("cidr:$cidr"); done <<< "$cidrs"
            count=${#all_entries[@]}

            if [ $count -le $MAX ]; then
              gen_addr "$OUTPUT_DIR/${site}.rsc" "$site" "${all_entries[@]}"
            else
              part=1; idx=0
              while [ $idx -lt $count ]; do
                chunk=("${all_entries[@]:idx:MAX}")
                gen_addr "$OUTPUT_DIR/${site}_part${part}.rsc" "$site" "${chunk[@]}"
                idx=$((idx + MAX))
                part=$((part + 1))
              done
            fi
          done

      # 2. IP4 → Address-List (iplistv4) — опционально
      - name: Process IP4 → Address-List (iplistv4)
        run: |
          set -e
          IFS=',' read -ra site_array <<< "${{ env.SITE_LIST }}"
          IP4_URL_TEMPLATE="${{ env.IP4_URL_TEMPLATE }}"
          MAX="${{ env.MAX_ENTRIES_PER_FILE }}"
          OUTPUT_DIR="for_scripts/iplistv4"
          mkdir -p "$OUTPUT_DIR"

          gen_addr() {
            local out="$1" comment="$2"
            shift 2
            {
              echo ":global AddressList"
              echo "/ip firewall address-list"
              for e in "$@"; do
                addr=${e#*:}
                echo ":do {add list=\$AddressList comment=$comment address=$addr} on-error {}"
              done
            } > "$out"
          }

          for site in "${site_array[@]}"; do
            site=$(echo "$site" | xargs)
            ip_url="${IP4_URL_TEMPLATE//\{site\}/$site}"
            curl -s -f "$ip_url" > "input_ip4_$site.txt" || continue

            ips=$(grep -E '^([0-9]{1,3}\.){3}[0-9]{1,3}$' "input_ip4_$site.txt" | sort -u)
            [ -z "$ips" ] && continue

            all_entries=()
            while IFS= read -r ip; do all_entries+=("ip:$ip"); done <<< "$ips"
            count=${#all_entries[@]}

            if [ $count -le $MAX ]; then
              gen_addr "$OUTPUT_DIR/${site}.rsc" "$site" "${all_entries[@]}"
            else
              part=1; idx=0
              while [ $idx -lt $count ]; do
                chunk=("${all_entries[@]:idx:MAX}")
                gen_addr "$OUTPUT_DIR/${site}_part${part}.rsc" "$site" "${chunk[@]}"
                idx=$((idx + MAX))
                part=$((part + 1))
              done
            fi
          done

      # Commit and push
      - name: Commit and push
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add for_scripts/
          if git diff --staged --quiet; then
            echo "No changes"
            exit 0
          fi
          git commit -m "Auto-update: Address-List for selected sites" || exit 0
          git push
